{% extends "base.html" %}
{% set page_title = t.card_rentals %}
{% block body %}

<h1 class="page-title" style="display:flex;align-items:center;justify-content:space-between">
  <span>üí≥ {{ t.card_rentals }}</span>
  <button class="btn" id="openRentalModal">{{ t.add }}</button>
</h1>

<!-- ÂàóË°® -->
<div class="panel">
  <table>
    <thead>
      <tr>
        <th>ID</th>
        <th>{{ t.card_name|default('Card Name') }}</th>
        <th>{{ t.rental_amount }}</th>
        <th>{{ t.date }}</th>
        <th>{{ t.note }}</th>
        <th>{{ t.status }}</th>
        <th>{{ t.created_at }}</th>
        <th>{{ t.actions }}</th>
      </tr>
    </thead>
    <tbody>
      {% for r in rows %}
      <tr>
        <td>{{ r.id }}</td>
        <td>{{ r.card_name }}</td>
        <td>{{ '%.2f'|format(r.rental_amount) }}</td>
        <td>{{ r.date }}</td>
        <td>{{ r.note }}</td>
        <td>
          {% if r.is_active %}
            <span class="badge on">{{ t.active }}</span>
          {% else %}
            <span class="badge off">{{ t.inactive }}</span>
          {% endif %}
        </td>
        <td>{{ r.created_at }}</td>
        <td>
          <form method="post" action="{{ url_for('card_rentals_toggle', cid=r.id) }}" style="display:inline">
            <button class="btn soft" type="submit">
              {% if r.is_active %}{{ t.deactivate }}{% else %}{{ t.activate }}{% endif %}
            </button>
          </form>
          <a class="btn" href="{{ url_for('card_rentals_edit_form', cid=r.id) }}">{{ t.edit }}</a>
          <form method="post" action="{{ url_for('card_rentals_delete', cid=r.id) }}" style="display:inline"
                onsubmit="return confirm('{{ t.confirm_delete }}')">
            <button class="btn danger" type="submit">{{ t.delete }}</button>
          </form>
        </td>
      </tr>
      {% else %}
      <tr><td colspan="8" class="empty">{{ t.empty }}</td></tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<!-- ============ Êñ∞Â¢ûÂºπÁ™óÔºàModalÔºâ ============ -->
<style>
  /* ‰ªÖÊú¨È°µ Modal Ê†∑ÂºèÔºåÈÅøÂÖçÂä®Âà∞ÂÖ®Â±Ä CSS */
  .cr-modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;z-index:50}
  .cr-modal.show{display:flex}
  .cr-backdrop{position:absolute;inset:0;background:rgba(0,0,0,.55)}
  .cr-dialog{
    position:relative; z-index:1; width:min(560px,92vw);
    background:var(--panel); border:1px solid var(--line); border-radius:14px;
    box-shadow:var(--shadow-1); padding:16px 16px 12px;
    backdrop-filter: blur(8px) saturate(1.05);
  }
  .cr-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px}
  .cr-title{font-weight:800}
  .cr-close{background:transparent;border:0;color:var(--text);font-size:20px;line-height:1;cursor:pointer}
  .cr-form{display:flex;flex-wrap:wrap;gap:10px}
  .cr-form input{flex:1 1 220px}
  .cr-actions{display:flex;gap:10px;justify-content:flex-end;margin-top:12px}
</style>

<div class="cr-modal" id="rentalModal" aria-hidden="true">
  <div class="cr-backdrop" data-close></div>
  <div class="cr-dialog" role="dialog" aria-modal="true" aria-labelledby="cr_title">
    <div class="cr-header">
      <div id="cr_title" class="cr-title">{{ t.add }} ¬∑ {{ t.card_rentals }}</div>
      <button class="cr-close" type="button" title="Close" aria-label="Close" data-close>√ó</button>
    </div>

    <!-- Ë°®ÂçïÊèê‰∫§Âà∞ /card-rentals/addÔºà‰øùÊåÅ app.py ‰∏çÂèòÔºâ -->
    <form class="cr-form" method="post" action="{{ url_for('card_rentals_add') }}">
      <!-- ÊâãÂä®ËæìÂÖ•Èì∂Ë°åÂç°Âêç -->
      <input id="cr_card_name" name="card_name" placeholder="{{ t.card_name|default('Card Name') }}" required>

      <input name="rental_amount" type="number" step="0.01" min="0" placeholder="{{ t.rental_amount }}" required>
      <input id="cr_date" name="date" type="date" placeholder="{{ t.date }}" required>
      <input name="note" placeholder="{{ t.note }}">

      <div class="cr-actions" style="flex:1 1 100%">
        <button class="btn soft" type="button" data-close>{{ t.back }}</button>
        <button class="btn" type="submit">{{ t.submit }}</button>
      </div>
    </form>
  </div>
</div>

<script>
  (function(){
    const modal = document.getElementById('rentalModal');
    const openBtn = document.getElementById('openRentalModal');
    const dateInput = document.getElementById('cr_date');
    const nameInput = document.getElementById('cr_card_name');

    function openModal(){
      modal.classList.add('show');
      // ÈªòËÆ§Êó•Êúü = ‰ªäÂ§©ÔºàYYYY-MM-DDÔºâ
      try{
        const today = new Date();
        const yyyy = today.getFullYear();
        const mm = String(today.getMonth()+1).padStart(2,'0');
        const dd = String(today.getDate()).padStart(2,'0');
        if (dateInput) dateInput.value = `${yyyy}-${mm}-${dd}`;
      }catch(e){}
      setTimeout(()=> nameInput && nameInput.focus(), 50);
    }
    function closeModal(){ modal.classList.remove('show'); }

    openBtn?.addEventListener('click', openModal);
    modal?.addEventListener('click', (e)=>{ if(e.target.matches('[data-close]')) closeModal(); });
    window.addEventListener('keydown', (e)=>{ if(e.key === 'Escape' && modal.classList.contains('show')) closeModal(); });
  })();
</script>

{% endblock %}
