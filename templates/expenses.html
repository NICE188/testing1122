{% extends "base.html" %}
{% set page_title = t.expenses %}
{% block body %}

<h1 class="page-title" style="display:flex;align-items:center;justify-content:space-between">
  <span>ğŸ’¸ {{ t.expenses }}</span>
  <button class="btn" id="openExpenseModal">{{ t.add }}</button>
</h1>

<!-- åˆ—è¡¨ -->
<div class="panel">
  <table>
    <thead>
      <tr>
        <th>ID</th>
        <th>{{ t.worker }}</th>
        <th>{{ t.expense_amount }}</th>
        <th>{{ t.date }}</th>
        <th>{{ t.category }}</th>
        <th>{{ t.note }}</th>
        <th>{{ t.status }}</th>
        <th>{{ t.created_at }}</th>
        <th>{{ t.actions }}</th>
      </tr>
    </thead>
    <tbody>
      {% for r in rows %}
      <tr>
        <td>{{ r.id }}</td>
        <td>{{ r.worker_name or '-' }}</td>
        <td>{{ '%.2f'|format(r.amount) }}</td>
        <td>{{ r.date }}</td>
        <td>{{ r.category or '-' }}</td>
        <td>{{ r.note }}</td>
        <td>
          {% if r.is_active %}
            <span class="badge on">{{ t.active }}</span>
          {% else %}
            <span class="badge off">{{ t.inactive }}</span>
          {% endif %}
        </td>
        <td>{{ r.created_at }}</td>
        <td>
          <form method="post" action="{{ url_for('expenses_toggle', eid=r.id) }}" style="display:inline">
            <button class="btn soft" type="submit">
              {% if r.is_active %}{{ t.deactivate }}{% else %}{{ t.activate }}{% endif %}
            </button>
          </form>
          <a class="btn" href="{{ url_for('expenses_edit_form', eid=r.id) }}">{{ t.edit }}</a>
          <form method="post" action="{{ url_for('expenses_delete', eid=r.id) }}" style="display:inline"
                onsubmit="return confirm('{{ t.confirm_delete }}')">
            <button class="btn danger" type="submit">{{ t.delete }}</button>
          </form>
        </td>
      </tr>
      {% else %}
      <tr><td colspan="9" class="empty">{{ t.empty }}</td></tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<!-- ================== ç¾è§‚å¼¹çª—ï¼šå¼€é”€è®°å½• ================== -->
<style>
/* â€”â€” ä»…æœ¬é¡µæ ·å¼ï¼ˆex-* å‰ç¼€ï¼‰ï¼Œä¸å½±å“å…¨ç«™ â€”â€” */
.ex-modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;z-index:60}
.ex-modal.show{display:flex;animation:ex-fadeIn .18s ease}
.ex-backdrop{position:absolute;inset:0;background:rgba(0,0,0,.55);backdrop-filter:blur(3px)}
.ex-dialog{
  position:relative; z-index:1; width:min(720px,92vw);
  border-radius:16px; padding:0; overflow:hidden;
  background:
    linear-gradient(180deg, rgba(148,163,184,.08), rgba(148,163,184,.04)) padding-box,
    linear-gradient(135deg, rgba(96,165,250,.75), rgba(167,139,250,.75), rgba(250,204,21,.55)) border-box;
  border:1px solid transparent;
  box-shadow:0 18px 60px rgba(0,0,0,.38);
  animation:ex-popIn .18s ease;
}
.ex-header{
  display:flex;align-items:center;justify-content:space-between;gap:10px;
  padding:14px 16px;
  background:linear-gradient(180deg, rgba(17,24,39,.92), rgba(17,24,39,.65));
  border-bottom:1px solid rgba(148,163,184,.18);
}
.ex-title{display:flex;align-items:center;gap:10px;font-weight:800}
.ex-sub{font-size:12px;color:var(--muted)}
.ex-close{background:transparent;border:0;color:var(--text);font-size:20px;line-height:1;cursor:pointer;opacity:.9}
.ex-close:hover{opacity:1;transform:scale(1.06)}

.ex-body{padding:14px 16px}
.ex-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:12px}
@media (max-width:720px){.ex-grid{grid-template-columns:1fr}}

.ex-field{
  display:flex;flex-direction:column;gap:6px;
  background:rgba(14,20,35,.9); border:1px solid rgba(148,163,184,.28);
  border-radius:12px; padding:10px 10px 9px;
  transition:border-color .15s ease, box-shadow .15s ease, background .15s ease;
}
.ex-field:focus-within{
  border-color:rgba(54,89,214,.55);
  box-shadow:0 0 0 3px rgba(54,89,214,.18);
  background:rgba(18,24,41,.95);
}
.ex-field label{font-size:12px;color:#cbd5e1;letter-spacing:.2px}
.ex-field input, .ex-field select{
  border:0;outline:none;background:transparent;color:var(--text)
}
.ex-field input::placeholder{color:#93a4c0}

.ex-actions{
  display:flex;gap:10px;justify-content:flex-end;
  padding:12px 16px;
  background:linear-gradient(180deg, rgba(17,24,39,.4), rgba(17,24,39,.25));
  border-top:1px solid rgba(148,163,184,.12);
}
.btn.primary{
  background:linear-gradient(180deg,#2b57f0,#274fe0);
  border-color:rgba(147,163,184,.28);
  color:#fff;
}
.btn.primary:hover{filter:brightness(1.06)}
.btn.ghost{background:transparent;border:1px solid rgba(148,163,184,.28)}

@keyframes ex-popIn{from{transform:translateY(8px) scale(.98);opacity:.0}to{transform:none;opacity:1}}
@keyframes ex-fadeIn{from{opacity:.0}to{opacity:1}}
</style>

<div class="ex-modal" id="expenseModal" aria-hidden="true">
  <div class="ex-backdrop" data-close></div>

  <div class="ex-dialog" role="dialog" aria-modal="true" aria-labelledby="ex_title">
    <div class="ex-header">
      <div>
        <div id="ex_title" class="ex-title">ğŸ’¸ {{ t.add }} Â· {{ t.expenses }}</div>
        <div class="ex-sub">{{ t.worker }}ï¼ˆå¯é€‰ï¼‰ã€{{ t.expense_amount }}ã€{{ t.date }}ã€{{ t.category }}ã€{{ t.note }}</div>
      </div>
      <button class="ex-close" type="button" title="Close" aria-label="Close" data-close>Ã—</button>
    </div>

    <form method="post" action="{{ url_for('expenses_add') }}">
      <div class="ex-body">
        <div class="ex-grid">
          <div class="ex-field">
            <label for="ex_worker">{{ t.worker }} ({{ 'optional' if lang=='en' else 'å¯é€‰' }})</label>
            <select id="ex_worker" name="worker_id">
              <option value="">{{ t.worker }} ({{ 'optional' if lang=='en' else 'å¯é€‰' }})</option>
              {% for w in workers %}
              <option value="{{ w.id }}">{{ w.name }}</option>
              {% endfor %}
            </select>
          </div>

          <div class="ex-field">
            <label for="ex_amount">{{ t.expense_amount }}</label>
            <input id="ex_amount" name="amount" type="number" step="0.01" min="0" placeholder="0.00" required>
          </div>

          <div class="ex-field">
            <label for="ex_date">{{ t.date }}</label>
            <input id="ex_date" name="date" type="date" required>
          </div>

          <!-- æ–°å¢ï¼šåˆ†ç±»ä¸‹æ‹‰ -->
          <div class="ex-field">
            <label for="ex_category">{{ t.category }}</label>
            <select id="ex_category" name="category">
              <option value="">è¯·é€‰æ‹©</option>
              <option>æ‰‹æœºè´¹ç”¨</option>
              <option>ä¼™é£Ÿ</option>
              <option>ç”µè„‘èŠ±è´¹</option>
              <option>å…¶ä»–</option>
            </select>
          </div>

          <div class="ex-field" style="grid-column:1/-1">
            <label for="ex_note">{{ t.note }}</label>
            <input id="ex_note" name="note" placeholder="å¯å¡«å†™å¤‡æ³¨ä¿¡æ¯">
          </div>
        </div>
      </div>

      <div class="ex-actions">
        <button class="btn ghost" type="button" data-close>{{ t.back }}</button>
        <button class="btn primary" type="submit">{{ t.submit }}</button>
      </div>
    </form>
  </div>
</div>

<script>
(function(){
  const modal = document.getElementById('expenseModal');
  const openBtn = document.getElementById('openExpenseModal');
  const dateInput = document.getElementById('ex_date');

  function todayISO(){
    const d = new Date();
    const yyyy = d.getFullYear();
    const mm = String(d.getMonth()+1).padStart(2,'0');
    const dd = String(d.getDate()).padStart(2,'0');
    return `${yyyy}-${mm}-${dd}`;
  }

  function openModal(){
    modal.classList.add('show');
    document.documentElement.style.overflow = 'hidden'; // é˜²æ­¢èƒŒæ™¯æ»šåŠ¨
    try{ if(dateInput && !dateInput.value) dateInput.value = todayISO(); }catch(e){}
  }
  function closeModal(){
    modal.classList.remove('show');
    document.documentElement.style.overflow = '';
  }

  openBtn?.addEventListener('click', openModal);
  modal?.addEventListener('click', (e)=>{ if(e.target.matches('[data-close]')) closeModal(); });
  window.addEventListener('keydown', (e)=>{ if(e.key==='Escape' && modal.classList.contains('show')) closeModal(); });
})();
</script>

{% endblock %}
